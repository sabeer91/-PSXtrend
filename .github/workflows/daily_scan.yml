name: PSX Daily Scanner

# 1. WHEN to run
on:
  schedule:
    # Runs at 12:30 UTC (which is 5:30 PM Pakistan Standard Time)
    # Monday (1) through Friday (5)
    - cron: '30 12 * * 1-5'
  
  # Allows you to click a "Run Now" button manually for testing
  workflow_dispatch:

# 2. PERMISSIONS (Crucial for saving the history file)
permissions:
  contents: write

# 3. THE JOBS
jobs:
  run-scanner:
    runs-on: ubuntu-latest

    steps:
      # A. Download your code
      - name: Checkout Code
        uses: actions/checkout@v4

      # B. Install Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip' # Caches libraries to make runs faster

      # C. Install your libraries
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      # D. Run the AI Agent
      - name: Run Agentic System
        env:
          # These grab the keys you saved in Repo Settings
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python main.py

      # E. Save "alert_history.json" back to the repo
      # This prevents the bot from alerting the same stock twice in one week
      - name: Commit Alert History
        run: |
          git config --global user.name 'PSX-Bot'
          git config --global user.email 'bot@noreply.github.com'
          # Add the file if it exists
          git add alert_history.json
          # Commit only if there are changes
          git diff --quiet && git diff --staged --quiet || (git commit -m "üìù Update Alert History [skip ci]" && git push)
