name: PSX Daily Scanner

# 1. WHEN to run
on:
  schedule:
    # Runs at 12:30 UTC (which is 5:30 PM Pakistan Standard Time)
    # Monday (1) through Friday (5)
    - cron: '30 12 * * 1-5'
  
  # Allows you to click a "Run Now" button manually for testing
  workflow_dispatch:

# 2. PERMISSIONS (Crucial for saving the history file)
permissions:
  contents: write

# 3. THE JOBS
jobs:
  run-scanner:
    runs-on: ubuntu-latest

    steps:
      # A. Download your code
      - name: Checkout Code
        uses: actions/checkout@v4

      # B. Install Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      # C. Install your libraries
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      # D. Run the AI Agent
      - name: Run Agentic System
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python main.py

      # E. Save "alert_history.json" back to the repo
      # This block is the FIX for the error you saw.
      - name: Commit Alert History
        run: |
          git config --global user.name 'PSX-Bot'
          git config --global user.email 'bot@noreply.github.com'
          
          # 1. If the file is missing, create a default empty JSON file
          # This prevents the "pathspec did not match" error
          if [ ! -f alert_history.json ]; then
            echo "{}" > alert_history.json
          fi
          
          # 2. Add the file to git staging (now guaranteed to exist)
          git add alert_history.json
          
          # 3. Commit and push only if there are actual changes
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ“ Update Alert History [skip ci]" && git push)
